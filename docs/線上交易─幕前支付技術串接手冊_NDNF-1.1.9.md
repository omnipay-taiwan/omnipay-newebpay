# 線上交易─幕前支付技術串接手冊

**藍新金流服務平台**

文件版本號：**NDNF-1.1.9**

*文件為藍新科技股份有限公司版權所有*

---

## 版本異動表

| 文件版本號 | 修改內容 | 日期 |
|-----------|--------|------|
| NDNF-1.0.0 | 初版 | 2022/05/27 |
| NDNF-1.0.1 | 參數 BankType 移除 Taishin=台新銀行、調整參數 CVSCOM 之訂單金額限制、新增參數 LgsType 店到店支援超商 | 2022/06/22 |
| NDNF-1.0.2 | 新增錯誤代碼 MPG05006/MPG05007/MPG05008/MPG05009、調整參數 CVSCOM 測試交易說明、調整參數 WEBATM 及 TradeLimit 說明 | 2022/07/28 |
| NDNF-1.0.3 | 新增 4.1.3 Form Post、4.1.4 AES256 解密、4.1.5 CheckValue、新增常見問題、新增參數 TradeStatus 狀態代碼、調整 Alipay/WeChat/LINE Pay 退款規則 | 2022/09/21 |
| NDNF-1.0.4 | 更新 MPG 交易[NPA-F01]常見問題、更新 LINE Pay 測試說明 | 2022/12/02 |
| NDNF-1.0.5 | 調整參數 ReturnURL / NotifyURL / CustomerURL / ClientBackURL / ImageUrl 之型態 | 2022/12/21 |
| NDNF-1.0.6 | 新增 LgsType 支援超商：萊爾富、OK mart、調整 WEBATM / VACC / TAIWANPAY 金額限制、新增超商物流 StoreType 回傳參數 | 2022/12/30 |
| NDNF-1.1.0 至 NDNF-1.1.9 | 持續優化更新 | 2023/01 - 2024/12 |

---

## 目錄

1. [簡介](#簡介)
2. [詞彙一覽表](#詞彙一覽表)
3. [交易流程](#交易流程)
4. [API 規格](#api-規格)
5. [支付方式](#支付方式)
6. [錯誤代碼表](#6-錯誤代碼表)
7. [常見問題](#7-常見問題)

---

## 簡介

線上交易─幕前支付是藍新金流推出的完整支付解決方案，為商店提供一個整合多種支付方式的接口。消費者可在商店網站完成支付，支援信用卡、電子錢包、超商代碼/條碼、虛擬帳號、超商取貨付款等多種支付方式，大幅提升交易便利性與轉換率。

---

## 詞彙一覽表

| 名稱 | 說明 |
|------|------|
| 藍新金流 | 藍新金流提供金流服務給商店，並提供付款頁面給消費者進行付款 |
| 會員 | 使用藍新金流服務之會員，一個會員可以建立多間商店 |
| 商店 | 會員建立使用藍新金流服務之網路商店 |
| 消費者 | 向商店購買商品或服務之付款方 |
| 交易序號 | 藍新金流給予每筆交易之唯一序號 |
| 訂單編號 | 商店自訂之訂單編號 |
| 幕前支付 | 在商店網站進行的支付交易 |
| 授權 | 信用卡交易的授權確認 |
| 請款 | 已授權交易的金額扣款 |
| 退款 | 已請款交易的金額退回 |

---

## 交易流程

### 基本交易流程

1. **消費者購物**：在商店網站瀏覽商品並選擇結帳
2. **發送支付請求**：商店伺服器向藍新金流發送支付請求
3. **選擇支付方式**：消費者在藍新金流付款頁面選擇支付方式
4. **完成支付**：根據支付方式進行授權或確認
5. **回傳結果**：藍新金流將交易結果回傳給商店
6. **完成交易**：商店確認結果並完成訂單處理

### 支付方式特性

| 支付方式 | 確認時間 | 特點 |
|---------|--------|------|
| 信用卡 | 即時 | 多種選項，包含分期 |
| WEBATM | 即時 | 線上 ATM 轉帳 |
| 虛擬帳號 | 1-3 天 | 消費者轉帳至帳號 |
| 超商代碼 | 7 天 | 消費者至超商繳款 |
| 超商條碼 | 7 天 | 掃描條碼繳款 |
| 超商取貨付款 | 現場 | 取貨時付款 |
| 電子錢包 | 即時 | 支付寶、微信、LINE Pay |

---

## API 規格

### 4.1 AES256 加密

#### Step 1: 準備參數

**PHP 範例：**
```php
$key="Fs5cX1TGqYM2PpdbE14a9H83YQSQF5jn";
$iv="C6AcmfqJILwgnhIP";
$mid="TEK1682407426";
```

#### Step 2: 生成請求字串

```php
$data = http_build_query(array(
    'MerchantID' => $mid,
    'RespondType' => 'JSON',
    'TimeStamp' => time(),
    'Version' => '2.0',
    'LangType' => 'zh-Tw',
    'MerOrderNo' => 'Order'.time(),
    'Amt' => 1000,
    'ItemDesc' => 'Test Item',
    'ReturnURL' => 'https://yoursite.com/return',
    'NotifyURL' => 'https://yoursite.com/notify',
));
```

#### Step 3: 加密

```php
$encrypt = bin2hex(openssl_encrypt($data, "AES-256-CBC", $key, OPENSSL_RAW_DATA, $iv));
```

#### Step 4: 計算檢查碼

```php
$checkValue = hash('sha256', 'HashKey=' . $key . '&' . $encrypt . '&HashIV=' . $iv);
```

### 4.2 AES256 解密

#### 解密步驟

```php
function strippadding($string) {
    $slast = ord(substr($string, -1));
    $slastc = chr($slast);
    $pcheck = substr($string, -$slast);
    if (preg_match("/$slastc{" . $slast . "}/", $string)) {
        $string = substr($string, 0, strlen($string) - $slast);
        return $string;
    } else {
        return false;
    }
}

$decrypted = strippadding(openssl_decrypt(hex2bin($encrypted), "AES-256-CBC", $key, OPENSSL_RAW_DATA|OPENSSL_ZERO_PADDING, $iv));
$result = json_decode($decrypted, true);
```

### 4.3 建立交易 [NPA-F01]

**測試環境：** https://ccore.newebpay.com/MPG/mpg_gateway

**正式環境：** https://core.newebpay.com/MPG/mpg_gateway

#### 請求參數

| 參數名稱 | 必填 | 型態 | 說明 |
|---------|-----|------|------|
| MerchantID | V | String | 商店代號 |
| RespondType | V | String | 回傳格式：JSON/String |
| TimeStamp | V | Long | Unix 時間戳 |
| Version | V | String | API 版本 (2.0) |
| LangType | | String | 語系：zh-Tw/en |
| MerOrderNo | V | String | 商店訂單編號 |
| Amt | V | Integer | 交易金額 (新台幣) |
| ItemDesc | V | String | 商品名稱 |
| ReturnURL | | String | 交易完成返回商店URL |
| NotifyURL | | String | 交易結果通知URL |
| CustomerURL | | String | 取消交易返回URL |
| PaymentMethod | | String | 指定支付方式 |
| TradeLimit | | Integer | 繳費期限(天) |
| ExpireDate | | String | 繳費截止日期 |

#### 回應參數

| 參數名稱 | 說明 |
|---------|------|
| Status | 交易狀態：SUCCESS/FAIL |
| Message | 回傳訊息 |
| Result | 交易結果 (JSON格式) |
| TradeNo | 交易序號 |
| MerchantOrderNo | 商店訂單編號 |
| Amt | 交易金額 |
| TradeStatus | 交易狀態代碼 |

### 4.4 請款/退款

#### 請款 API

需與藍新金流申請開通，用於已授權交易的金額扣款。

#### 退款 API

支援全額或部分退款，需於規定時間內執行。

---

## 支付方式

### 1. 信用卡 (CREDIT)

- 支援台灣發卡銀行信用卡
- 支援 3D Secure 驗證
- 支援智能分期付款
- 支援紅利折抵
- **金額限制**：1 元 ~ 無上限

### 2. WEBATM

- 線上 ATM 轉帳
- 即時確認
- **金額限制**：1 元 ~ 100,000 元

### 3. 虛擬帳號 (VACC)

- 消費者轉帳至虛擬帳號
- 確認時間：1-3 個工作天
- **金額限制**：1 元 ~ 999,999 元

### 4. 超商代碼 (CVS)

- 消費者至超商繳款
- 繳款期限：7 天
- **金額限制**：1 元 ~ 20,000 元

### 5. 超商條碼 (BARCODE)

- 掃描條碼至超商繳款
- 繳款期限：7 天
- **金額限制**：1 元 ~ 20,000 元

### 6. 超商取貨付款 (CVSCOM)

- 消費者取貨時支付
- 支援超商：7-ELEVEN、全家、OK mart、萊爾富
- **金額限制**：1 元 ~ 10,000 元

### 7. 支付寶 (ALIPAY)

- 支援支付寶帳號支付
- 即時確認
- 支援國際交易

### 8. 微信支付 (WECHAT)

- 支援微信錢包支付
- 即時確認
- 支援國際交易

### 9. LINE Pay

- 支援 LINE Pay 帳號支付
- 即時確認
- 支援積分折抵

### 10. 銀聯卡 (UNIONPAY)

- 支援銀聯卡支付
- 非 3D 驗證交易
- 支援分期付款

### 11. 台灣 Pay (TAIWANPAY)

- 支援台灣 Pay 支付
- 搭配行動 PIN
- 即時確認

---

## 6. 錯誤代碼表

### MPG 系列錯誤代碼 (交易層級)

| 錯誤代碼 | 錯誤說明 |
|---------|--------|
| MPG01001 | 商店代號不存在或無效 |
| MPG01002 | 時間戳記不可空白 |
| MPG01005 | TokenTerm 不可空白或設定錯誤 |
| MPG01008 | 分期參數設定錯誤 |
| MPG01009 | 商店代號不可空白 |
| MPG01010 | 程式版本設定錯誤 |
| MPG01011 | 回傳規格設定錯誤 |
| MPG01012 | 商店訂單編號不可空白或設定錯誤 |
| MPG01013 | 付款人電子信箱設定錯誤 |
| MPG01014 | 網址設定錯誤 |
| MPG01015 | 訂單金額錯誤 |
| MPG01016 | 檢查碼設定錯誤 |
| MPG01017 | 商品資訊不可空白 |
| MPG01018 | 繳費有效期限設定錯誤 |
| MPG01023 | 交易加密資料不可空白 |
| MPG01024 | 交易加密 SHA 資料不可空白 |
| MPG01025 | 金融機構格式錯誤 |
| MPG01026 | 金融機構格式錯誤，不接受該參數 |
| MPG01027 | 一銀維護中，請選擇其他金融機構 |
| MPG01028 | 訂單細項格式錯誤 |
| MPG01029 | 訂單金額與訂單細項總金額不相符 |
| MPG01030 | 訂單細項品項編號不可重複 |

### MPG02 系列 (商店驗證)

| 錯誤代碼 | 錯誤說明 |
|---------|--------|
| MPG02001 | 檢查碼錯誤 |
| MPG02002 | 查無商店開啟任何金流服務 |
| MPG02003 | 支付方式未啟用，請洽客服中心 |
| MPG02004 | 交易超過 180 秒 |
| MPG02005 | 驗證資料錯誤(來源不合法) |
| MPG02006 | 信用卡收單機構系統發生異常 |
| MPG02007 | 參數錯誤 |
| MPG02008 | 版本不支援 |
| MPG02009 | 強制設定檢核轉出行或 ATM2.0 |
| MPG02010 | 此版本不支援，請升級至 v2.3 |

### MPG03 系列 (交易驗證)

| 錯誤代碼 | 錯誤說明 |
|---------|--------|
| MPG03001 | FormPost 加密失敗 |
| MPG03002 | 拒絕交易 IP |
| MPG03003 | IP 交易次數限制 |
| MPG03004 | 商店狀態已被暫停或關閉 |
| MPG03005 | 回傳參數資料不存在/解密失敗 |
| MPG03006 | 回傳參數資料不存在/解密失敗 |
| MPG03007 | TradeInfo 與回傳 MerchantID 不一致 |
| MPG03008 | 已存在相同的商店訂單編號 |
| MPG03009 | EncryptType 參數值錯誤 |
| MPG03010 | 驗證資料不存在或錯誤 |
| MPG03011 | 訂單資料已不存在 |

### MPG05 系列 (支付方式)

| 錯誤代碼 | 錯誤說明 |
|---------|--------|
| MPG05001 | 信用卡驗證資料解密失敗 |
| MPG05002 | 本商店不支援此信用卡付款 |
| MPG05003 | 此信用卡不支援分期付款 |
| MPG05004 | 發卡行無法提供分期服務 |
| MPG05005 | 警示交易 |
| MPG05006 | 物流設定參數錯誤 |
| MPG05007 | 無法使用超商取貨不付款服務 |
| MPG05008 | 金額限制關係 |
| MPG05009 | 超商物流設定錯誤 |

### TRA 系列 (交易相關)

| 錯誤代碼 | 錯誤說明 |
|---------|--------|
| TRA10001 | 商店資料取得失敗 |
| TRA10003 | 金額必須為數字 |
| TRA10008 | 資料加密錯誤 |
| TRA10009 | 商店代號不可空白 |
| TRA10012 | 商店代號停用 |
| TRA10013 | 商店信用卡資格停用 |
| TRA10015 | 網路連線失敗 |
| TRA10018 | 資料不足 |
| TRA10021 | 查無該筆交易或交易類型不符 |
| TRA10026 | 此訂單非授權成功狀態 |
| TRA10027 | 此訂單已申請過請款 |
| TRA10028 | 退款金額超過授權金額 |
| TRA10029 | 請款超過授權日 N 天 |
| TRA10030 | 模擬信用卡請款失敗 |
| TRA10031 | IndexType 單號類型錯誤 |
| TRA10032 | 單號類型說明 |
| TRA10033 | 商店自訂單號不可空白 |
| TRA10035 | 交易狀態不正確 |
| TRA10036 | 超過剩餘可退款金額 |
| TRA10037 | 商家自訂單號格式錯誤 |
| TRA10038 | 選擇使用系統單號格式錯誤 |
| TRA10039 | 退款金額超過請款金額 |
| TRA10041 | 網址格式錯誤 |
| TRA10045 | 交易正在退款中或失敗 |
| TRA10046 | 交易撥款狀態異常 |
| TRA10047 | 交易不為授權成功狀態 |
| TRA10048 | 交易正在請款狀態 |
| TRA10049 | 交易正在退款狀態 |
| TRA10050 | 金額不符 |
| TRA10051 | 取消授權失敗 |
| TRA10054 | 檢查碼 CheckValue 錯誤 |
| TRA10058 | 動態貨幣轉換交易只接授全額請款 |
| TRA10070 | 銀聯卡交易無需請款 |
| TRA10071 | 查詢功能已鎖定，待四小時解鎖 |
| TRA10077 | 只能退未撥金額 |
| TRA10094 | 資料取消失敗 |
| TRA10095 | 此筆交易已過關帳時間 |
| TRA10675 | 紅利交易只接授全額請退款 |
| TRA10678 | 銀聯卡退款失敗 |
| TRA10702 | 達到請退款筆數上限，待 1 小時後解鎖 |
| TRA11002 | 請待 4 小時解鎖 |
| TRA20001 | 金融機構取消授權批次處理中 |
| TRA20002 | 查無交易資料 |
| TRA20004 | 商店訂單編號重覆 |
| TRA20011 | 該筆交易已請款 |
| TRA20027 | 此訂單已申請過退款 |
| TRA20028 | 退款失敗 |
| TRA40014 | TimeStamp 欄位錯誤 |

### 其他錯誤代碼

| 錯誤代碼 | 錯誤說明 |
|---------|--------|
| ACC10005 | 會員已被暫時停權/永久停權 |
| NOR1001 | 連線異常 |

---

## 7. 常見問題

### 關於 API 整合

**Q: 如何開始使用藍新金流服務？**

A: 
1. 前往藍新金流官網申請商店帳號
2. 完成身份驗證和商店審核
3. 取得商店代號、Hash Key 和 Hash IV
4. 根據文件進行系統整合
5. 完成測試環境驗證後上線

**Q: 支援哪些程式語言？**

A: 藍新金流提供 HTTP API，所有支援 HTTP 和加密演算法的程式語言都可整合，包括 PHP、Java、Python、Node.js、C#、Go 等。

### 關於支付方式

**Q: 如何選擇支付方式？**

A: 根據商店經營的商品類型選擇：
- 信用卡：快速便利，適合日常消費
- 電子錢包：用戶多，轉換率高
- 超商支付：適合遊戲點數、虛擬商品
- 分期付款：適合高客單價商品

**Q: 消費者可以同時使用多個支付方式嗎？**

A: 可以。商店在請求時可不指定特定支付方式，讓消費者自行選擇；或透過 PaymentMethod 參數指定特定方式。

### 關於交易結果

**Q: 如何確認交易是否成功？**

A: 
1. 判斷 Status 參數是否為 SUCCESS
2. 檢查 TradeStatus 是否為 1（交易成功）
3. 驗證 CheckValue 確保資料未被篡改

**Q: 為什麼沒有收到交易結果通知？**

A: 
1. 檢查 NotifyURL 是否設定正確
2. 確認伺服器是否正常接收 POST 請求
3. 檢查防火牆/網路設定
4. 使用查詢 API 確認交易狀態

---

*文件為藍新科技股份有限公司版權所有*
